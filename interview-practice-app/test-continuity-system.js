/**
 * é€£ç¶šæ€§å¼·åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * extractContinuityKeywordsé–¢æ•°ã¨getDepthStrategyé–¢æ•°ã®å‹•ä½œã‚’ç¢ºèª
 */

// ãƒ†ã‚¹ãƒˆç”¨ã®é–¢æ•°ï¼ˆAPIã‹ã‚‰æŠ½å‡ºï¼‰
function extractContinuityKeywords(studentResponse) {
  const keywords = [];
  
  // æ´»å‹•é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
  const activityKeywords = studentResponse.match(/ãƒ¡ãƒ€ã‚«|ãƒ€ãƒ³ã‚¹|ç’°å¢ƒå§”å“¡ä¼š|pH|æ°´è³ª|æŒ¯ä»˜|ãƒãƒ¼ãƒ |è¦³å¯Ÿ|è¨˜éŒ²|æ¸¬å®š|ç·´ç¿’|ç™ºè¡¨|æ–‡åŒ–ç¥­|å§”å“¡ä¼š|æ¤ç‰©|è‚²æˆ/g) || [];
  keywords.push(...activityKeywords);
  
  // å›°é›£ãƒ»èª²é¡Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
  const challengeKeywords = studentResponse.match(/å›°ã£ãŸ|å¤§å¤‰|é›£ã—ã‹ã£ãŸ|ã†ã¾ãã„ã‹ãª|å¤±æ•—|å•é¡Œ|èª²é¡Œ|è‹¦åŠ´|æ­»ã‚“ã§|ã ã‚|æ‚ªã/g) || [];
  keywords.push(...challengeKeywords);
  
  // å”åŠ›ãƒ»äººç‰©ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
  const peopleKeywords = studentResponse.match(/å…ˆç”Ÿ|å‹é”|ä»²é–“|ã¿ã‚“ãª|ä¸€ç·’|æ¯|çˆ¶|ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼|ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ¼ãƒˆ/g) || [];
  keywords.push(...peopleKeywords);
  
  // æ„Ÿæƒ…ãƒ»ä½“é¨“ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
  const emotionKeywords = studentResponse.match(/å¬‰ã—ã‹ã£ãŸ|æ¥½ã—ã‹ã£ãŸ|æ‚²ã—ã‹ã£ãŸ|é©šã„ãŸ|ç™ºè¦‹|æ°—ã¥ã„ãŸ|å­¦ã‚“ã |æ„Ÿã˜ãŸ/g) || [];
  keywords.push(...emotionKeywords);
  
  // æ–¹æ³•ãƒ»ãƒ—ãƒ­ã‚»ã‚¹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
  const methodKeywords = studentResponse.match(/ä½¿ã£ã¦|è©¦é¨“ç´™|é“å…·|å™¨å…·|æ¸¬å®š|æ‰‹é †|æ–¹æ³•|ã‚„ã‚Šæ–¹|å·¥å¤«|æ”¹å–„|å¯¾å‡¦/g) || [];
  keywords.push(...methodKeywords);
  
  // é‡è¤‡å‰Šé™¤
  return [...new Set(keywords)];
}

function getDepthStrategy(depth) {
  if (depth <= 2) {
    return {
      strategy: 'åŸºæœ¬æƒ…å ±ã®ç¢ºèªã¨æ´»å‹•è©³ç´°ã®æŠŠæ¡',
      focus: 'æ´»å‹•ã®æ¦‚è¦ã€å§‹ã‚ãŸãã£ã‹ã‘ã€åŸºæœ¬çš„ãªå–ã‚Šçµ„ã¿å†…å®¹',
      questionTypes: 'ã€Œã„ã¤ã‹ã‚‰ã€ã€Œã©ã®ã‚ˆã†ãªã€ã€Œãªãœå§‹ã‚ãŸã€',
      examples: [
        'ã€Œãã®æ´»å‹•ã¯ã„ã¤é ƒã‹ã‚‰å§‹ã‚ã‚‰ã‚ŒãŸã®ã§ã™ã‹ï¼Ÿã€',
        'ã€Œæœ€åˆã«å§‹ã‚ã‚ˆã†ã¨æ€ã£ãŸãã£ã‹ã‘ã¯ä½•ã§ã—ãŸã‹ï¼Ÿã€'
      ]
    };
  } else if (depth <= 4) {
    return {
      strategy: 'å›°é›£ãƒ»èª²é¡Œã®è©³ç´°æ¢æ±‚',
      focus: 'ã†ã¾ãã„ã‹ãªã‹ã£ãŸä½“é¨“ã€ç›´é¢ã—ãŸå•é¡Œã€èª²é¡Œã¸ã®å¯¾å‡¦',
      questionTypes: 'ã€Œå›°ã£ãŸã“ã¨ã€ã€Œå¤§å¤‰ã ã£ãŸã“ã¨ã€ã€Œã†ã¾ãã„ã‹ãªã‹ã£ãŸã€',
      examples: [
        'ã€Œãã®æ´»å‹•ã§ä¸€ç•ªå›°ã£ãŸã“ã¨ã¯ä½•ã§ã—ãŸã‹ï¼Ÿã€',
        'ã€Œæ€ã†ã‚ˆã†ã«ã„ã‹ãªã‹ã£ãŸæ™‚ã¯ã©ã†å¯¾å‡¦ã—ã¾ã—ãŸã‹ï¼Ÿã€'
      ]
    };
  } else if (depth <= 6) {
    return {
      strategy: 'å”åŠ›ãƒ»æ”¯æ´é–¢ä¿‚ã®æ¢æ±‚',
      focus: 'å‘¨ã‚Šã®äººã¨ã®å”åŠ›ã€å…ˆç”Ÿã‚„å‹é”ã‹ã‚‰ã®æ”¯æ´ã€ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯',
      questionTypes: 'ã€Œèª°ã¨ä¸€ç·’ã«ã€ã€Œå…ˆç”Ÿã«ç›¸è«‡ã€ã€Œå‹é”ã®å”åŠ›ã€',
      examples: [
        'ã€Œãã‚Œã¯ä¸€äººã§è§£æ±ºã—ã¾ã—ãŸã‹ã€ãã‚Œã¨ã‚‚èª°ã‹ã¨ä¸€ç·’ã§ã—ãŸã‹ï¼Ÿã€',
        'ã€Œãã®æ™‚ã€å…ˆç”Ÿã‚„å‹é”ã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿã€'
      ]
    };
  } else {
    return {
      strategy: 'æ·±å±¤ä½“é¨“ãƒ»ãƒ¡ã‚¿èªçŸ¥ã®æ¢æ±‚',
      focus: 'è‡ªå·±å¤‰åŒ–ã®å®Ÿæ„Ÿã€å­¦ã³ã®æœ¬è³ªã€ç¶™ç¶šã¸ã®æ„æ¬²',
      questionTypes: 'ã€Œã©ã†å¤‰ã‚ã£ãŸã€ã€Œä½•ã‚’å­¦ã‚“ã ã€ã€Œä»Šå¾Œã©ã†ã—ãŸã„ã€',
      examples: [
        'ã€Œãã®ä½“é¨“ã‚’é€šã—ã¦ã€è‡ªåˆ†è‡ªèº«ã¯ã©ã®ã‚ˆã†ã«å¤‰ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿã€',
        'ã€Œä»ŠæŒ¯ã‚Šè¿”ã£ã¦ã¿ã¦ã€ä¸€ç•ªå¤§ããªå­¦ã³ã¯ä½•ã§ã—ãŸã‹ï¼Ÿã€'
      ]
    };
  }
}

// ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
const keywordTestCases = [
  {
    name: "Hã•ã‚“ãƒ€ãƒ³ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³",
    response: "å°å­¦3å¹´ç”Ÿã‹ã‚‰ãƒãƒ¼ãƒ ãƒ€ãƒ³ã‚¹ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚æœ€åˆã¯æŒ¯ä»˜ã‚’è¦šãˆã‚‹ã®ãŒç²¾ä¸€æ¯ã§ã—ãŸãŒã€ã ã‚“ã ã‚“ãƒãƒ¼ãƒ å…¨ä½“ã®è¡¨ç¾ã‚’åˆã‚ã›ã‚‹ã“ã¨ã®å¤§åˆ‡ã•ã‚’å­¦ã³ã¾ã—ãŸã€‚ç‰¹ã«æ–‡åŒ–ç¥­ã®ç™ºè¡¨ã§ã¯ã€ã¿ã‚“ãªã§ä½•åº¦ã‚‚è©±ã—åˆã£ã¦ã€ãã‚Œãã‚Œã®å‹•ãã‚’èª¿æ•´ã—ã¾ã—ãŸã€‚æŒ¯ä»˜ã«ã°ã‚‰ã¤ããŒã‚ã£ã¦ãªã‹ãªã‹ãã‚ã‚ãªã‹ã£ãŸã®ã§ã™ãŒã€ãŠäº’ã„ã®å‹•ãã‚’è¦‹ãªãŒã‚‰ç·´ç¿’ã‚’é‡ã­ã¦ã€æœ€çµ‚çš„ã«ã¯ã¨ã¦ã‚‚è‰¯ã„ç™ºè¡¨ãŒã§ãã¾ã—ãŸã€‚",
    expectedKeywords: ["ãƒ€ãƒ³ã‚¹", "ãƒãƒ¼ãƒ ", "æŒ¯ä»˜", "æ–‡åŒ–ç¥­", "ç™ºè¡¨", "ç·´ç¿’", "ã¿ã‚“ãª", "å­¦ã‚“ã "]
  },
  {
    name: "Tã•ã‚“ãƒ¡ãƒ€ã‚«ãƒ‘ã‚¿ãƒ¼ãƒ³",
    response: "å°å­¦4å¹´ç”Ÿã‹ã‚‰ç’°å¢ƒå§”å“¡ä¼šã«æ‰€å±ã—ã¦ã€ãƒ¡ãƒ€ã‚«ã®é£¼è‚²ã¨æ°´è³ªç®¡ç†ã‚’ã—ã¦ã„ã¾ã™ã€‚æœ€åˆã¯ãŸã é¤Œã‚’ã‚ã’ã‚‹ã ã‘ã§ã—ãŸãŒã€ã ã‚“ã ã‚“æ°´ã®æ±šã‚Œã‚„pHå€¤ã«èˆˆå‘³ã‚’æŒã¤ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚pHå€¤ã‚’æ¸¬å®šã—ã¦è¨˜éŒ²ã‚’ã¤ã‘ãŸã‚Šã€æ°´æ¸©ã‚„é…¸ç´ é‡ã‚‚èª¿ã¹ã¦ã„ã¾ã™ã€‚æ™‚ã€…ãƒ¡ãƒ€ã‚«ãŒæ­»ã‚“ã§ã—ã¾ã†ã“ã¨ã‚‚ã‚ã£ã¦æ‚²ã—ã‹ã£ãŸã®ã§ã™ãŒã€åŸå› ã‚’èª¿ã¹ã¦æ”¹å–„ç­–ã‚’è€ƒãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚",
    expectedKeywords: ["ç’°å¢ƒå§”å“¡ä¼š", "å§”å“¡ä¼š", "ãƒ¡ãƒ€ã‚«", "æ°´è³ª", "pH", "æ¸¬å®š", "è¨˜éŒ²", "æ‚²ã—ã‹ã£ãŸ", "æ”¹å–„"]
  },
  {
    name: "å›°é›£ä½“é¨“ãƒ‘ã‚¿ãƒ¼ãƒ³",
    response: "ãã®æ™‚ã¯æœ¬å½“ã«å›°ã‚Šã¾ã—ãŸã€‚å…ˆç”Ÿã«ç›¸è«‡ã—ã¦ã¿ãŸã®ã§ã™ãŒã€ãªã‹ãªã‹è§£æ±ºç­–ãŒè¦‹ã¤ã‹ã‚‰ãšå¤§å¤‰ã§ã—ãŸã€‚å‹é”ã¨ä¸€ç·’ã«å·¥å¤«ã—ã¦ã€æœ€çµ‚çš„ã«ã¯å•é¡Œã‚’è§£æ±ºã™ã‚‹ã“ã¨ãŒã§ãã¦å¬‰ã—ã‹ã£ãŸã§ã™ã€‚",
    expectedKeywords: ["å›°ã£ãŸ", "å¤§å¤‰", "å…ˆç”Ÿ", "å‹é”", "ä¸€ç·’", "å·¥å¤«", "å•é¡Œ", "å¬‰ã—ã‹ã£ãŸ"]
  }
];

const depthTestCases = [
  { depth: 1, expectedStrategy: "åŸºæœ¬æƒ…å ±ã®ç¢ºèªã¨æ´»å‹•è©³ç´°ã®æŠŠæ¡" },
  { depth: 2, expectedStrategy: "åŸºæœ¬æƒ…å ±ã®ç¢ºèªã¨æ´»å‹•è©³ç´°ã®æŠŠæ¡" },
  { depth: 3, expectedStrategy: "å›°é›£ãƒ»èª²é¡Œã®è©³ç´°æ¢æ±‚" },
  { depth: 4, expectedStrategy: "å›°é›£ãƒ»èª²é¡Œã®è©³ç´°æ¢æ±‚" },
  { depth: 5, expectedStrategy: "å”åŠ›ãƒ»æ”¯æ´é–¢ä¿‚ã®æ¢æ±‚" },
  { depth: 6, expectedStrategy: "å”åŠ›ãƒ»æ”¯æ´é–¢ä¿‚ã®æ¢æ±‚" },
  { depth: 7, expectedStrategy: "æ·±å±¤ä½“é¨“ãƒ»ãƒ¡ã‚¿èªçŸ¥ã®æ¢æ±‚" },
  { depth: 8, expectedStrategy: "æ·±å±¤ä½“é¨“ãƒ»ãƒ¡ã‚¿èªçŸ¥ã®æ¢æ±‚" }
];

console.log("ğŸ”— é€£ç¶šæ€§å¼·åŒ–ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆé–‹å§‹\n");

// ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºãƒ†ã‚¹ãƒˆ
console.log("=== ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºãƒ†ã‚¹ãƒˆ ===");
keywordTestCases.forEach((testCase, index) => {
  const extractedKeywords = extractContinuityKeywords(testCase.response);
  const foundExpectedKeywords = testCase.expectedKeywords.filter(keyword => 
    extractedKeywords.includes(keyword)
  );
  
  console.log(`\nãƒ†ã‚¹ãƒˆ ${index + 1}: ${testCase.name}`);
  console.log(`å›ç­”: "${testCase.response.substring(0, 100)}..."`);
  console.log(`æœŸå¾…ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: [${testCase.expectedKeywords.join(', ')}]`);
  console.log(`æŠ½å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: [${extractedKeywords.join(', ')}]`);
  console.log(`ä¸€è‡´æ•°: ${foundExpectedKeywords.length}/${testCase.expectedKeywords.length}`);
  console.log(`çµæœ: ${foundExpectedKeywords.length >= testCase.expectedKeywords.length * 0.6 ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
});

// æ·±åº¦æˆ¦ç•¥ãƒ†ã‚¹ãƒˆ
console.log("\n\n=== æ·±åº¦æˆ¦ç•¥ãƒ†ã‚¹ãƒˆ ===");
depthTestCases.forEach((testCase, index) => {
  const strategy = getDepthStrategy(testCase.depth);
  const isCorrect = strategy.strategy === testCase.expectedStrategy;
  
  console.log(`\nãƒ†ã‚¹ãƒˆ ${index + 1}: æ·±åº¦${testCase.depth}å±¤`);
  console.log(`æœŸå¾…æˆ¦ç•¥: ${testCase.expectedStrategy}`);
  console.log(`å®Ÿéš›æˆ¦ç•¥: ${strategy.strategy}`);
  console.log(`ãƒ•ã‚©ãƒ¼ã‚«ã‚¹: ${strategy.focus}`);
  console.log(`è³ªå•ã‚¿ã‚¤ãƒ—: ${strategy.questionTypes}`);
  console.log(`çµæœ: ${isCorrect ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
});

console.log("\nğŸ¯ é€£ç¶šæ€§å¼·åŒ–ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå®Œäº†");